# 北京地铁线路规划系统

## 项目简介
这是一个基于 Python Flask 的地铁线路规划系统，能够为用户提供最短时间或最少换乘的地铁路线规划服务。系统采用可视化界面，让用户能够直观地选择起点和终点站，并展示详细的乘车路线。系统还支持地铁线路编辑功能，用户可以添加、删除站点和线路，自定义地铁网络。

## 主要功能
- 可视化地铁线路图展示
- 支持点击选择起点和终点站
- 提供两种路线规划模式：
  - 最短时间路线
  - 最少换乘路线
- 详细的换乘指引和站点信息
- 支持环形线路的双向路径规划
- **线路编辑功能**:
  - 添加新站点到现有线路
  - 删除非换乘站点
  - 延长已有线路
  - 创建全新线路
  - 自定义线路速度和站点间距离

## 技术栈
- 后端：Python Flask
- 前端：HTML5, CSS3, JavaScript, Leaflet地图库
- 数据存储：JSON 配置文件
- 算法：
  - 改进的 Dijkstra 算法（最短时间）
  - DFS 算法（最少换乘）
  - NetworkX 图库用于路径规划

## 项目结构
```
project/
│
├── app.py                 # Flask 应用主程序
├── main.py                # 生产环境启动程序
├── test.py                # 测试程序
│
├── services/
│   ├── subway_system.py   # 地铁系统核心类
│   ├── subway_planner.py  # 路线规划算法实现
│   ├── subway_editor.py   # 地铁系统编辑工具类
│   └── data_loader.py     # 数据加载和处理
│
├── models/
│   ├── station.py         # 站点模型类
│   └── line.py            # 线路模型类
│
├── static/
│   ├── css/               # 样式文件
│   ├── js/                # JavaScript 文件
│   │   ├── map.js         # 地图交互逻辑
│   │   ├── main.js        # 主页面交互逻辑
│   │   └── latlng.js      # 地理坐标数据
│   └── images/            # 图片资源
│
├── templates/
│   └── index.html         # 主页面模板
│
├── utils/
│   └── initializer.py     # 数据初始化工具
│
└── resources/
    └── data/
        └── line_speed_final.json # 地铁线路数据
```

## 项目模块说明

### 核心模块
1. `subway_system.py`
   - 地铁系统的核心类实现
   - 管理站点和线路信息
   - 提供路线规划的统一接口
   - 负责调用不同的路线规划算法
   - 包含`SubwaySystemEditor`内部类用于编辑地铁网络

2. `subway_planner.py`
   - 实现路线规划的核心算法
   - 包含最短时间算法（Dijkstra）
   - 包含最少换乘算法（DFS）
   - 处理环形线路的特殊情况
   - 使用NetworkX图结构优化路径搜索

3. `subway_editor.py`
   - 地铁网络编辑工具
   - 提供站点和线路的增删改功能
   - 维护站点间的连接关系

### Web 应用模块
1. `app.py`
   - Flask 应用程序入口
   - 处理 HTTP 请求和路由
   - 提供 RESTful API 接口
   - 渲染前端页面
   - 处理地铁编辑请求

2. `templates/index.html`
   - 主页面模板
   - 展示地铁线路图
   - 处理用户交互
   - 显示查询结果和编辑界面

3. `static/js/map.js`
   - 地图交互逻辑
   - 绘制地铁线路和站点
   - 处理站点点击事件
   - 处理路线规划显示
   - 实现地铁线路编辑功能

## 系统编辑功能说明
地铁系统编辑功能允许用户自定义地铁网络，主要包括：

1. **添加新站点**
   - 在现有线路的两个相邻站点之间添加新站点
   - 系统自动处理站点间连接关系
   - 支持设置站点间距离

2. **删除站点**
   - 支持删除非换乘站点
   - 自动重新建立被删除站点两侧站点之间的连接

3. **延长线路**
   - 从线路终点站延长线路
   - 添加新站点并设置连接距离

4. **创建新线路**
   - 创建全新的地铁线路
   - 设置线路速度和起始站点
   - 支持与现有线路建立换乘关系

5. **自定义站点**
   - 在地图上点选位置添加自定义站点
   - 设置站点所属线路和与其他站点的连接关系

## 安装和运行
1. 确保已安装 Python 3.7 或更高版本
2. 安装依赖包：
```bash
pip install flask networkx
```

## 启动程序的三种方式

1. 通过 app.py 运行（开发模式）
```bash
python app.py
```

2. 通过 main.py 运行（生产模式）
```bash
python main.py
```

3. 运行测试程序
```bash
python test.py
```

## 测试说明

### test.py 文件说明
test.py 文件用于测试地铁系统的核心功能，主要包括：
1. 测试路线规划功能
   - 测试最短时间路径规划
   - 测试最少换乘路径规划
   - 测试环形线路的双向路径规划

2. 测试数据加载功能
   - 测试站点数据加载
   - 测试线路数据加载
   - 测试站点间连接关系

3. 测试编辑功能
   - 测试添加站点
   - 测试删除站点
   - 测试创建新线路

## 使用说明

### 路线规划
1. 打开系统后，您会看到地铁线路图
2. 点击任意站点选择起点（第一次点击）
3. 再次点击另一个站点选择终点（第二次点击）
4. 系统会自动计算并显示推荐路线
5. 可以切换最短时间/最少换乘模式查看不同路线方案
6. 如需重新选择，直接点击新的站点即可重新开始选择过程

### 地铁编辑
1. 在地图界面，可以通过右键菜单或控制面板访问编辑功能
2. 添加站点：
   - 选择要添加站点的线路
   - 选择前后相邻的站点
   - 输入新站点名称和与相邻站点的距离
3. 删除站点：
   - 选择要删除的站点（不能是换乘站）
   - 确认删除操作
4. 创建新线路：
   - 点击地图位置确定起始站点
   - 输入线路名称和速度
   - 选择是否与现有站点建立连接

## 特色功能
1. 智能换乘：自动计算最优换乘方案
2. 双向路径：支持环形线路的双向选择
3. 直观操作：点击式站点选择
4. 实时响应：选择站点后自动规划路线
5. 灵活编辑：支持自定义地铁网络
6. 地图交互：基于Leaflet的地图可视化
7. 等待时间模拟：模拟真实乘车等待时间
8. 多方案对比：显示多种路线方案供选择

## 开发说明
1. 后端使用Flask框架提供RESTful API服务
2. 前端使用Leaflet地图库实现地铁网络可视化
3. 路径规划算法基于NetworkX图库实现
4. 线路和站点数据使用JSON格式存储
5. 系统设计支持扩展更多地铁网络数据

