<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>北京地铁线路查询系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet-contextmenu CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-contextmenu@1.4.0/dist/leaflet.contextmenu.min.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet-contextmenu JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-contextmenu@1.4.0/dist/leaflet.contextmenu.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
        }
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .subway-line {
            margin-bottom: 30px;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background-color: #f8f9fa;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .subway-line:hover {
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .station-btn {
            margin: 0;
            width: 100%;
            max-width: 110px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .station-btn:hover {
            background: #e7f1ff;
            transform: translateY(-1px);
        }
        .station-btn.selected {
            background: #007bff;
            color: white;
            font-weight: bold;
        }
        .line-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .line-header h5 {
            margin: 0;
            color: #0056b3;
            font-weight: bold;
        }
        .speed-badge {
            background-color: #e7f1ff;
            color: #0056b3;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        .edit-forms {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            background-color: #f8f9fa;
        }
        .edit-forms.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        .nav-tabs {
            border-bottom: none;
        }
        .nav-tabs .nav-link {
            border: none;
            padding: 10px 20px;
            margin-right: 5px;
            border-radius: 10px 10px 0 0;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            background-color: white;
            border-bottom: 3px solid #007bff;
        }
        .control-panel {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .route-modal .modal-content {
            border-radius: 15px;
        }
        .route-modal .modal-header {
            background-color: #f8f9fa;
            border-radius: 15px 15px 0 0;
        }
        .route-details {
            padding: 20px;
            line-height: 1.6;
        }
        .route-segment {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .stations {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 10px;
        }
        .station-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
            min-height: 70px;
        }
        .transfer-info {
            min-height: 20px;
            margin-top: 4px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2px;
        }
        .transfer-badge {
            padding: 1px 4px;
            font-size: 0.65rem;
            background-color: #e7f1ff;
            color: #0056b3;
            border-radius: 3px;
            white-space: nowrap;
        }
        .error-feedback {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        .form-control.is-invalid {
            border-color: #dc3545;
        }
        .form-control.is-invalid + .error-feedback {
            display: block;
        }
        /* 地图容器样式 */
        #subway-map {
            height: 600px; 
            width: 100%; 
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }
        /* 确保tab-pane使用flex布局，使地图能够撑满容器 */
        .tab-pane {
            display: flex;
            flex-direction: column;
        }
        /* 让地图容器在垂直方向上撑满可用空间 */
        #map {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        /* 站点标签样式 */
        .station-label {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #0056b3;
            padding: 2px 4px;
            font-size: 10px;
            white-space: nowrap;
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* 地图信息面板 */
        #mapSelectionStatus {
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            max-width: 100%;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        /* 地图控制面板 */
        .map-control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }
        .route-info-container {
            max-height: 100px;
            overflow-y: auto;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            margin-top: 10px;
        }
        /* 美化滚动条 */
        .route-info-container::-webkit-scrollbar {
            width: 8px;
        }
        .route-info-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .route-info-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .route-info-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* 路线信息样式 */
        .map-route-info {
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .map-route-info div {
            margin-bottom: 6px;
        }
        /* 路线路径显示 */
        .map-route-info div:first-child {
            white-space: nowrap;
            overflow-x: auto;
            padding-bottom: 6px;
        }
        /* 可滚动内容容器 */
        .scrollable-content {
            max-height: 400px;
            overflow-y: auto;
        }
        /* 美化所有滚动条 */
        .scrollable-content::-webkit-scrollbar,
        .route-info-container::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track,
        .route-info-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .scrollable-content::-webkit-scrollbar-thumb,
        .route-info-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover,
        .route-info-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* 多方案路线样式 */
        .route-plan {
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .route-plan:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .route-plan:nth-child(2n) {
            border-left-color: #28a745;
        }
        .route-plan:nth-child(3n) {
            border-left-color: #fd7e14;
        }
        .route-plan h5 {
            color: #007bff;
            font-weight: bold;
        }
        /* 路线方案标识样式 */
        .route-badge {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            color: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .route-header {
            position: relative;
            text-align: center;
            margin-bottom: 15px;
        }
        /* 地图路线结果容器 */
        .map-route-container {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-top: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }
        /* 地图多路线方案容器 */
        .map-route-results-container {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            display: none; /* 默认隐藏，有结果时显示 */
        }
        /* 地图路线方案项 */
        .map-route-plan {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .map-route-plan:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .map-route-plan.active {
            box-shadow: 0 0 0 2px #007bff, 0 4px 8px rgba(0,0,0,0.2);
        }
        .map-route-badge {
            font-size: 0.9rem;
            padding: 0.3rem 0.8rem;
            border-radius: 30px;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            margin-right: 8px;
        }
        .map-route-lines {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        .map-line-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
        }
        /* 增强规划路线的显示效果 */
        .leaflet-interactive {
            transition: opacity 0.3s, weight 0.3s;
            cursor: pointer; /* 确保鼠标显示为可点击状态 */
        }
        
        /* 替换脉动动画，使用静态高亮效果 */
        .station-marker-highlight {
            filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.8));
        }
        
        /* 规划路线高亮效果 */
        .route-highlight {
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.7));
            z-index: 900 !important;
        }
        /* 站点编辑表单样式 */
        .station-edit-popup .leaflet-popup-content {
            margin: 0;
            width: 100% !important;
            padding: 0;
        }
        
        .station-edit-popup .leaflet-popup-content-wrapper {
            padding: 0;
            border-radius: 8px;
            overflow: hidden;
            min-width: 400px;
        }
        
        .station-edit-popup .card {
            border: none;
            box-shadow: none;
        }
        
        /* 右键菜单样式 */
        .leaflet-contextmenu {
            box-shadow: 0 1px 7px rgba(0,0,0,0.4);
            background-color: white;
            border-radius: 4px;
            padding: 4px 0;
        }
        
        .leaflet-contextmenu a.leaflet-contextmenu-item {
            display: block;
            line-height: 20px;
            border-top: 1px solid transparent;
            border-bottom: 1px solid transparent;
            padding: 8px 12px;
            text-decoration: none;
            background-color: white;
            cursor: pointer;
            color: #222;
        }
        
        .leaflet-contextmenu a.leaflet-contextmenu-item:hover {
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }
        
        .leaflet-contextmenu a.leaflet-contextmenu-item-disabled {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">北京地铁线路查询系统</h1>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="lines-tab" data-bs-toggle="tab" data-bs-target="#lines" type="button">线路信息</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button">编辑线路</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map" type="button">地图查询</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- 线路信息面板 -->
            <div class="tab-pane fade show active" id="lines">
                <div class="control-panel">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex gap-3 align-items-center">
                                <div class="input-group" style="max-width: 200px;">
                                    <span class="input-group-text">起点</span>
                                    <input type="text" class="form-control" id="start" list="stationList" placeholder="点击或输入站点名">
                                </div>
                                <div class="input-group" style="max-width: 200px;">
                                    <span class="input-group-text">终点</span>
                                    <input type="text" class="form-control" id="end" list="stationList" placeholder="点击或输入站点名">
                                </div>
                                <button id="resetSelection" class="btn btn-outline-secondary">重置</button>
                            </div>
                            <div class="mt-2">
                                <small id="selectionStatus" class="text-muted">请选择或输入起点站</small>
                            </div>
                            <!-- 添加站点列表数据 -->
                            <datalist id="stationList">
                            </datalist>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button class="btn btn-outline-primary active" data-mode="time">最短时间</button>
                                <button class="btn btn-outline-primary" data-mode="transfers">最少换乘</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="subwayLines"></div>
            </div>

            <!-- 编辑线路面板 -->
            <div class="tab-pane fade" id="edit">
                <div class="btn-group w-100 mb-4">
                    <button class="btn btn-outline-primary" onclick="showEditForm('add')">添加站点</button>
                    <button class="btn btn-outline-primary" onclick="showEditForm('remove')">删除站点</button>
                </div>

                <!-- 添加站点表单 -->
                <div id="addStationForm" class="edit-forms">
                    <h4>添加站点</h4>
                    <form onsubmit="handleAddStation(event)">
                        <div class="mb-3">
                            <label class="form-label">线路编号</label>
                            <input type="text" class="form-control" name="line_id" required>
                            <div class="error-feedback">请输入有效的线路编号（如：1号线、13号线）</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">前一站名</label>
                            <input type="text" class="form-control" name="prev_station" required>
                            <div class="error-feedback">该站点不存在于指定线路中</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">后一站名</label>
                            <input type="text" class="form-control" name="next_station" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">新站点名称</label>
                            <input type="text" class="form-control" name="new_station" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">与前一站距离(米)</label>
                            <input type="number" class="form-control" name="prev_distance" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">与后一站距离(米)</label>
                            <input type="number" class="form-control" name="next_distance" required>
                        </div>
                        <button type="submit" class="btn btn-primary">添加站点</button>
                    </form>
                </div>

                <!-- 删除站点表单 -->
                <div id="removeStationForm" class="edit-forms">
                    <h4>删除站点</h4>
                    <form onsubmit="handleRemoveStation(event)">
                        <div class="mb-3">
                            <label class="form-label">站点名称</label>
                            <input type="text" class="form-control" name="station" required>
                            <div class="error-feedback">该站点不存在</div>
                        </div>
                        <button type="submit" class="btn btn-danger">删除站点</button>
                    </form>
                </div>
            </div>

            <!-- 添加地图查询面板 -->
            <div class="tab-pane fade" id="map">
                <div class="control-panel">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex gap-3 align-items-center">
                                <div class="input-group" style="max-width: 200px;">
                                    <span class="input-group-text">起点</span>
                                    <input type="text" class="form-control" id="map-start" list="stationList" placeholder="点击或输入站点名">
                                </div>
                                <div class="input-group" style="max-width: 200px;">
                                    <span class="input-group-text">终点</span>
                                    <input type="text" class="form-control" id="map-end" list="stationList" placeholder="点击或输入站点名">
                                </div>
                                <button id="mapResetSelection" class="btn btn-outline-secondary">重置</button>
                                <button id="queryMapRoute" class="btn btn-primary">查询路线</button>
                            </div>
                            <div class="mt-2">
                                <div id="mapSelectionStatus" class="route-info-container">
                                    <small class="text-muted">请选择或输入起点站</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button class="btn btn-outline-primary active" data-map-mode="time">最短时间</button>
                                <button class="btn btn-outline-primary" data-map-mode="transfers">最少换乘</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="mapRouteResults" class="map-route-results-container">
                    <!-- 这里将显示多个路线方案 -->
                </div>
                <div id="subway-map"></div>
                <div class="map-instructions mt-3">
                    <p class="text-muted">
                        <small>
                            <i class="bi bi-info-circle"></i> 
                            使用说明: 点击地图上的站点可以设置起点和终点，第一次点击为起点，第二次点击为终点。
                            放大地图可以查看站点名称。选择"最短时间"或"最少换乘"模式来获取不同的路线规划结果。
                            点击路线方案可在地图上高亮显示该路线。
                        </small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 路线结果模态框 -->
    <div class="modal fade route-modal" id="routeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">乘车方案</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="routeResult" class="route-details scrollable-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/latlng.js"></script>
    <script src="/static/js/map.js"></script>
    <script>
        let selectedStations = [];
        let currentMode = 'time';
        let subwayData = null;
        let routeModal = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            routeModal = new bootstrap.Modal(document.getElementById('routeModal'));
            initializeSubwayData();
        });

        // 初始化：获取地铁线路数据
        async function initializeSubwayData() {
            try {
                const response = await fetch('/get_subway_data');
                subwayData = await response.json();
                displaySubwayLines(subwayData);
            } catch (error) {
                alert('加载地铁数据失败：' + error.message);
            }
        }

        // 显示地铁线路
        function displaySubwayLines(data) {
            const container = document.getElementById('subwayLines');
            container.innerHTML = '';
            
            // 将线路按照自然顺序排序
            const sortedLines = Object.entries(data).sort((a, b) => {
                // 提取数字部分
                const getLineNumber = (str) => {
                    const match = str.match(/(\d+)/);
                    return match ? parseInt(match[0]) : Infinity;
                };
                
                const aNum = getLineNumber(a[0]);
                const bNum = getLineNumber(b[0]);
                
                // 如果都是数字线路，按数字排序
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return aNum - bNum;
                }
                
                // 如果有特殊线路（如S1线、八通线等），放在后面
                if (isNaN(aNum)) return 1;
                if (isNaN(bNum)) return -1;
                
                return 0;
            });

            sortedLines.forEach(([lineId, lineInfo]) => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'subway-line';
                
                const header = document.createElement('div');
                header.className = 'line-header';
                header.innerHTML = `
                    <h5>${lineId}</h5>
                    <span class="speed-badge">时速: ${lineInfo.speed}km/h</span>
                `;
                
                const stations = document.createElement('div');
                stations.className = 'stations';
                
                lineInfo.stations.forEach(station => {
                    const stationContainer = document.createElement('div');
                    stationContainer.className = 'station-container';
                    
                    const btn = document.createElement('button');
                    btn.className = 'station-btn';
                    btn.textContent = station;
                    btn.onclick = () => handleStationClick(station);
                    
                    stationContainer.appendChild(btn);
                    
                    // 添加换乘信息
                    const transferLines = getTransferLines(station, lineId);
                    if (transferLines.length > 0) {
                        const transferInfo = document.createElement('div');
                        transferInfo.className = 'transfer-info';
                        transferLines.forEach(transferLine => {
                            const badge = document.createElement('span');
                            badge.className = 'transfer-badge';
                            badge.textContent = transferLine;
                            transferInfo.appendChild(badge);
                        });
                        stationContainer.appendChild(transferInfo);
                    }
                    
                    stations.appendChild(stationContainer);
                });
                
                lineDiv.appendChild(header);
                lineDiv.appendChild(stations);
                container.appendChild(lineDiv);
            });
        }

        // 获取换乘线路信息
        function getTransferLines(station, currentLine) {
            const transferLines = [];
            // 从地铁数据中获取该站点所属的所有线路
            Object.entries(subwayData).forEach(([lineId, lineInfo]) => {
                if (lineId !== currentLine && lineInfo.stations.includes(station)) {
                    transferLines.push(lineId);
                }
            });
            return transferLines;
        }

        // 获取输入框元素
        const startInput = document.getElementById('start');
        const endInput = document.getElementById('end');

        // 处理输入框输入事件
        startInput.addEventListener('change', function() {
            handleStationInput(this.value, 0);
        });

        endInput.addEventListener('change', function() {
            handleStationInput(this.value, 1);
        });

        // 处理站点输入
        function handleStationInput(stationName, index) {
            // 检查站点是否存在
            let stationExists = false;
            Object.values(subwayData).some(line => {
                if (line.stations.includes(stationName)) {
                    stationExists = true;
                    return true;
                }
            });

            if (!stationExists) {
                alert('该站点不存在！');
                if (index === 0) {
                    startInput.value = '';
                } else {
                    endInput.value = '';
                }
                return;
            }

            // 更新选中状态
            if (index === 0) {
                if (selectedStations.length > 0) {
                    selectedStations[0] = stationName;
                } else {
                    selectedStations.push(stationName);
                }
            } else {
                if (selectedStations.length > 1) {
                    selectedStations[1] = stationName;
                } else if (selectedStations.length === 1) {
                    selectedStations.push(stationName);
                } else {
                    alert('请先选择起点站！');
                    endInput.value = '';
                    return;
                }
            }

            // 更新站点按钮选中状态
            updateStationButtonsState();

            // 更新状态提示
            updateSelectionStatus();

            // 如果已选择两个站点，执行查询
            if (selectedStations.length === 2) {
                queryRoute();
            }
        }

        // 更新站点按钮状态
        function updateStationButtonsState() {
            document.querySelectorAll('.station-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (selectedStations.includes(btn.textContent)) {
                    btn.classList.add('selected');
                }
            });
        }

        // 更新选择状态提示
        function updateSelectionStatus() {
            const statusEl = document.getElementById('selectionStatus');
            const resetBtn = document.getElementById('resetSelection');
            
            if (selectedStations.length === 0) {
                statusEl.textContent = '请选择或输入起点站';
                resetBtn.disabled = true;
                startInput.value = '';
                endInput.value = '';
            } else if (selectedStations.length === 1) {
                statusEl.textContent = '请选择或输入终点站';
                resetBtn.disabled = false;
                startInput.value = selectedStations[0];
            } else {
                startInput.value = selectedStations[0];
                endInput.value = selectedStations[1];
            }
        }

        // 修改重置功能
        document.getElementById('resetSelection').onclick = () => {
            selectedStations = [];
            updateStationButtonsState();
            updateSelectionStatus();
        };

        // 修改站点点击处理函数
        function handleStationClick(station) {
            fetch('/click_station', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    station: station,
                    currentStart: startInput.value || null,
                    currentEnd: endInput.value || null
                })
            })
            .then(response => response.json())
            .then(data => {
                // 更新输入框
                startInput.value = data.start || '';
                endInput.value = data.end || '';
                
                // 更新选中状态
                selectedStations = [];
                if (data.start) selectedStations.push(data.start);
                if (data.end) selectedStations.push(data.end);
                
                // 更新UI状态
                updateStationButtonsState();
                updateSelectionStatus();
                
                // 如果起点和终点都已选择，自动查询路线
                if (data.start && data.end) {
                    queryRoute();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('操作失败，请重试');
            });
        }

        // 切换查询模式
        document.querySelectorAll('[data-mode]').forEach(btn => {
            btn.onclick = (e) => {
                currentMode = e.target.dataset.mode;
                document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                if (selectedStations.length === 2) {
                    queryRoute();
                }
            };
        });

        // 查询路线
        async function queryRoute() {
            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start: selectedStations[0],
                        end: selectedStations[1],
                        mode: currentMode
                    })
                });
                const result = await response.json();
                
                // 在显示模态框前更新内容
                document.getElementById('routeResult').innerHTML = formatRouteResult(result.result);
                document.querySelector('.modal-title').textContent = `${selectedStations[0]} → ${selectedStations[1]} 乘车方案`;
                
                // 显示模态框
                routeModal.show();
            } catch (error) {
                alert('查询失败：' + error.message);
            }
        }

        // 格式化路线结果
        function formatRouteResult(result) {
            // 分离路线结果的不同部分
            const lines = result.split('\n');
            
            // 检查是否是最少换乘模式（包含多个路线方案）
            const isMultipleRoutes = result.includes('最少换乘路线方案') && result.includes('路线 1');
            
            if (isMultipleRoutes) {
                // 为最少换乘模式创建特殊格式
                return formatMultipleRoutes(lines);
            } else {
                // 单一路线模式的原有格式化逻辑
                const basicInfo = [];
                const detailedRoutes = [];
                let isDetailedSection = false;
                
                lines.forEach(line => {
                    if (line.includes('详细路线:')) {
                        isDetailedSection = true;
                        return;
                    }
                    
                    if (isDetailedSection) {
                        detailedRoutes.push(line);
                    } else {
                        basicInfo.push(line);
                    }
                });
                
                // 格式化基本信息
                const formattedBasicInfo = basicInfo.map(line => {
                    if (line.startsWith('===')) return `<h5 class="text-center mt-2 mb-3">${line}</h5>`;
                    return `<div>${line}</div>`;
                }).join('');
                
                // 格式化详细路线
                const formattedDetailedRoutes = detailedRoutes.map(line => {
                    if (line.trim() === '') return '';
                    if (line.startsWith('乘坐')) {
                        return `<div class="route-segment"><strong>${line}</strong></div>`;
                    }
                    if (line.startsWith('=')) return '<hr>';
                    return `<div class="ms-3">${line}</div>`;
                }).join('');
                
                // 组合所有内容
                return `
                    <div class="basic-info mb-3">
                        ${formattedBasicInfo}
                    </div>
                    <div class="detailed-routes">
                        <h6>详细路线:</h6>
                        ${formattedDetailedRoutes}
                    </div>
                `;
            }
        }
        
        // 格式化最少换乘的多个路线方案
        function formatMultipleRoutes(lines) {
            // 提取标题部分
            const title = lines.find(line => line.includes('最少换乘路线方案'));
            
            // 根据路线标记分割多个路线方案
            const routes = [];
            let currentRoute = [];
            let routeIndex = 0;
            
            lines.forEach(line => {
                if (line.match(/={15} 路线 \d+ ={15}/)) {
                    if (currentRoute.length > 0) {
                        routes.push({
                            index: routeIndex,
                            content: currentRoute
                        });
                    }
                    routeIndex = parseInt(line.match(/路线 (\d+)/)[1]);
                    currentRoute = [line];
                } else if (routeIndex > 0) {
                    currentRoute.push(line);
                }
            });
            
            // 添加最后一个路线
            if (currentRoute.length > 0) {
                routes.push({
                    index: routeIndex,
                    content: currentRoute
                });
            }
            
            // 格式化每个路线方案
            const formattedRoutes = routes.map((route, idx) => {
                // 为每个方案确定一个颜色
                const colors = ['#007bff', '#28a745', '#fd7e14', '#dc3545', '#6f42c1'];
                const routeColor = colors[idx % colors.length];
                
                // 将每个路线方案分为基本信息和详细路线
                const basicInfo = [];
                const detailedRoutes = [];
                let isDetailedSection = false;
                
                route.content.forEach(line => {
                    if (line.includes('详细路线:')) {
                        isDetailedSection = true;
                        return;
                    }
                    
                    if (isDetailedSection) {
                        detailedRoutes.push(line);
                    } else {
                        basicInfo.push(line);
                    }
                });
                
                // 格式化基本信息
                const formattedBasicInfo = basicInfo.map(line => {
                    if (line.match(/={15} 路线 \d+ ={15}/)) {
                        return `
                            <div class="route-header" style="border-color: ${routeColor}">
                                <h5 class="text-center mt-2 mb-3" style="color: ${routeColor}">
                                    <span class="badge bg-secondary route-badge" style="background-color: ${routeColor} !important;">方案 ${route.index}</span>
                                </h5>
                            </div>
                        `;
                    }
                    return `<div>${line}</div>`;
                }).join('');
                
                // 格式化详细路线
                const formattedDetailedRoutes = detailedRoutes.map(line => {
                    if (line.trim() === '') return '';
                    if (line.startsWith('乘坐')) {
                        return `<div class="route-segment"><strong>${line}</strong></div>`;
                    }
                    if (line.startsWith('=')) return '<hr>';
                    return `<div class="ms-3">${line}</div>`;
                }).join('');
                
                // 组合该路线方案的内容
                return `
                    <div class="route-plan mb-4 p-3 bg-light rounded" style="border-left-color: ${routeColor}">
                        <div class="basic-info mb-3">
                            ${formattedBasicInfo}
                        </div>
                        <div class="detailed-routes">
                            <h6>详细路线:</h6>
                            ${formattedDetailedRoutes}
                        </div>
                    </div>
                `;
            }).join('');
            
            // 返回标题和所有路线方案
            return `
                <h4 class="text-center mb-3">${title || '最少换乘路线方案'}</h4>
                ${formattedRoutes}
            `;
        }

        // 显示编辑表单
        function showEditForm(formType) {
            document.querySelectorAll('.edit-forms').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(`${formType}StationForm`).classList.add('active');
        }

        // 验证线路是否存在
        function validateLine(lineId) {
            return subwayData.hasOwnProperty(lineId);
        }

        // 验证站点是否存在于指定线路
        function validateStation(station, lineId) {
            return subwayData[lineId]?.stations.includes(station);
        }

        // 验证站点是否相邻
        function validateAdjacentStations(station1, station2, lineId) {
            const stations = subwayData[lineId]?.stations;
            if (!stations) return false;
            const index1 = stations.indexOf(station1);
            const index2 = stations.indexOf(station2);
            return Math.abs(index1 - index2) === 1;
        }

        // 处理添加站点
        async function handleAddStation(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // 重置所有错误状态
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            // 验证线路
            if (!validateLine(data.line_id)) {
                const input = form.querySelector('[name="line_id"]');
                input.classList.add('is-invalid');
                return;
            }
            
            // 验证前后站点存在性和相邻性
            if (!validateStation(data.prev_station, data.line_id) || 
                !validateStation(data.next_station, data.line_id)) {
                form.querySelector('[name="prev_station"]').classList.add('is-invalid');
                form.querySelector('[name="next_station"]').classList.add('is-invalid');
                return;
            }
            
            if (!validateAdjacentStations(data.prev_station, data.next_station, data.line_id)) {
                form.querySelector('[name="prev_station"]').classList.add('is-invalid');
                form.querySelector('[name="next_station"]').classList.add('is-invalid');
                return;
            }
            
            // 验证距离
            if (data.prev_distance <= 0 || data.next_distance <= 0) {
                const distInputs = form.querySelectorAll('[type="number"]');
                distInputs.forEach(input => input.classList.add('is-invalid'));
                return;
            }

            // 如果验证通过，发送请求
            try {
                await handleEditOperation('/edit/add_station', data);
                form.reset();
            } catch (error) {
                alert('操作失败：' + error.message);
            }
        }

        // 处理删除站点
        async function handleRemoveStation(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // 验证站点是否存在
            let stationExists = false;
            Object.values(subwayData).some(line => {
                if (line.stations.includes(data.station)) {
                    stationExists = true;
                    return true;
                }
            });
            
            if (!stationExists) {
                form.querySelector('[name="station"]').classList.add('is-invalid');
                return;
            }

            // 验证是否为换乘站（不能删除换乘站）
            const transferCount = Object.values(subwayData).filter(line => 
                line.stations.includes(data.station)
            ).length;
            
            if (transferCount > 1) {
                alert('不能删除换乘站！');
                return;
            }

            try {
                await handleEditOperation('/edit/remove_station', data);
                form.reset();
            } catch (error) {
                alert('操作失败：' + error.message);
            }
        }

        // 处理编辑操作
        async function handleEditOperation(endpoint, formData) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    // 使用返回的新数据更新界面
                    subwayData = result.data;
                    displaySubwayLines(subwayData);
                    document.querySelectorAll('.edit-forms').forEach(form => {
                        form.classList.remove('active');
                    });
                }
            } catch (error) {
                alert('操作失败：' + error.message);
            }
        }
    </script>
</body>
</html> 